<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Milano Management System</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase Scripts -->
    <script type="module">
        // Import Firebase modules - FIXED v10 API
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getDatabase, ref, set, get, update, remove, onValue, onChildAdded, onChildChanged, onChildRemoved, query, orderByChild, equalTo, limitToFirst, startAt, endAt } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        
        // Firebase config - FIXED storage bucket
        const firebaseConfig = {
            apiKey: "AIzaSyAKPaTK5565yymhgdg7SW_-k5lx4-r3BfE",
            authDomain: "milano-2a686.firebaseapp.com",
            projectId: "milano-2a686",
            storageBucket: "milano-2a686.appspot.com", // FIXED: ƒê√∫ng domain
            messagingSenderId: "1060141074286",
            appId: "1:1060141074286:web:ec528fc13ac8fd2afbe37f",
            measurementId: "G-TK1GC0FT8Y",
            databaseURL: "https://milano-2a686-default-rtdb.firebaseio.com"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        
        // Anonymous sign-in v·ªõi graceful fallback
        signInAnonymously(auth).then(() => {
            console.log('‚úÖ Signed in anonymously to Firebase');
        }).catch(error => {
            console.warn('‚ö†Ô∏è Firebase auth warning (Anonymous might be disabled):', error.code);
            // Kh√¥ng ch·∫∑n app, ch·ªâ hi·ªÉn th·ªã warning
        });
        
        // Expose to window v·ªõi c·∫•u tr√∫c CHU·∫®N - FIXED structure
        window.firebaseApp = {
            app,
            db,
            auth,
            // C√°c h√†m database ri√™ng l·∫ª
            database: {
                ref,
                set,
                get,
                update,
                remove,
                onValue,
                onChildAdded,
                onChildChanged,
                onChildRemoved,
                query,
                orderByChild,
                equalTo,
                limitToFirst,
                startAt,
                endAt
            }
        };
        
        console.log('‚úÖ Firebase initialized successfully');
        
        // Kh·ªüi t·∫°o s·ªõm ƒë·ªÉ c√°c module kh√°c c√≥ th·ªÉ s·ª≠ d·ª•ng
        window.firebaseReady = true;
        window.dispatchEvent(new CustomEvent('firebaseReady'));
    </script>
    
    <style>
        /* Th√™m loading animation */
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        .loading i {
            font-size: 40px;
            margin-bottom: 20px;
            color: #4CAF50;
        }
        .loading p {
            font-size: 18px;
            margin-bottom: 10px;
        }
        .loading small {
            display: block;
            margin-top: 10px;
            color: #888;
            font-size: 14px;
        }
        .loading small.error {
            color: #f44336;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="tabs">
            <button class="tab-btn active" data-tab="reports">
                <i class="fas fa-chart-line"></i>
                <span>B√°o c√°o</span>
            </button>
            <button class="tab-btn" data-tab="inventory">
                <i class="fas fa-boxes"></i>
                <span>Kho</span>
            </button>
            <button class="tab-btn" data-tab="employees">
                <i class="fas fa-users"></i>
                <span>Nh√¢n vi√™n</span>
            </button>
            <button class="tab-btn" data-tab="dashboard">
                <i class="fas fa-tachometer-alt"></i>
                <span>T·ªïng quan</span>
            </button>
           
        <div class="tab-btn" id="syncStatus">
            <i class="fas fa-circle offline" id="syncIcon"></i>
            <span id="syncText">Offline</span>
            <span class="badge" id="syncBadge" style="display: none">0</span>
        </div>
    </header>

    <main class="main-content" id="mainContent">
        <div class="loading" id="initialLoading">
            <i class="fas fa-spinner fa-spin"></i>
            <p>ƒêang kh·ªüi t·∫°o h·ªá th·ªëng...</p>
            <small id="loadingDetail">ƒêang k·∫øt n·ªëi Firebase</small>
        </div>
    </main>

    <div class="toast-container" id="toastContainer"></div>

    <div class="modal-overlay" id="modalOverlay"></div>
    <div class="modal-container" id="modalContainer"></div>

    <!-- Load c√°c module SAU khi Firebase ƒë√£ s·∫µn s√†ng -->
    <script src="firebase-manager-simple.js"></script>
    <script src="data.js"></script>
    <script src="reports.js"></script>
    <script src="inventory.js"></script>
    <script src="employees.js"></script>
    <script src="dashboard.js"></script>
    
    <script>
        // Kh·ªüi t·∫°o app
        async function initializeApp() {
            console.log('üöÄ Milano App Starting...');
            
            // Update loading status
            updateLoadingDetail('ƒêang k·∫øt n·ªëi Firebase...');
            
            try {
                // ƒê·ª£i Firebase kh·ªüi t·∫°o
                await waitForFirebase();
                
                // Initialize data manager
                updateLoadingDetail('T·∫£i d·ªØ li·ªáu...');
                await window.dataManager.init();
                
                // ·∫®n loading
                setTimeout(() => {
                    document.getElementById('initialLoading').style.display = 'none';
                    showTab('reports');
                    
                    // Start sync
                    startBackgroundSync();
                    
                    console.log('üéâ App initialized successfully');
                    window.showToast?.('H·ªá th·ªëng ƒë√£ s·∫µn s√†ng', 'success');
                }, 800);
                
            } catch (error) {
                console.error('‚ùå App initialization failed:', error);
                updateLoadingDetail('L·ªói kh·ªüi t·∫°o', true);
                
                // Hi·ªÉn th·ªã fallback UI
                setTimeout(() => {
                    document.getElementById('initialLoading').innerHTML = `
                        <div style="color: #f44336; padding: 20px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 40px; margin-bottom: 20px;"></i>
                            <p>Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß</p>
                            <small>·ª®ng d·ª•ng s·∫Ω ch·∫°y ·ªü ch·∫ø ƒë·ªô offline</small>
                            <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px;">
                                <i class="fas fa-redo"></i> Th·ª≠ l·∫°i
                            </button>
                        </div>
                    `;
                    // V·∫´n hi·ªÉn th·ªã app ·ªü ch·∫ø ƒë·ªô offline
                    setTimeout(() => {
                        document.getElementById('initialLoading').style.display = 'none';
                        showTab('reports');
                    }, 2000);
                }, 1000);
            }
        }
        
        // ƒê·ª£i Firebase kh·ªüi t·∫°o
        function waitForFirebase() {
            return new Promise((resolve, reject) => {
                const startTime = Date.now();
                const maxWait = 8000; // 8 seconds max
                
                // Ki·ªÉm tra xem Firebase ƒë√£ s·∫µn s√†ng ch∆∞a
                if (window.firebaseApp && window.firebaseApp.db) {
                    resolve(true);
                    return;
                }
                
                // N·∫øu ch∆∞a, ƒë·ª£i s·ª± ki·ªán firebaseReady
                const onFirebaseReady = () => {
                    if (window.firebaseApp && window.firebaseApp.db) {
                        clearTimeout(timeoutId);
                        window.removeEventListener('firebaseReady', onFirebaseReady);
                        resolve(true);
                    }
                };
                
                const checkInterval = setInterval(() => {
                    if (window.firebaseApp && window.firebaseApp.db) {
                        clearInterval(checkInterval);
                        resolve(true);
                    } else if (Date.now() - startTime > maxWait) {
                        clearInterval(checkInterval);
                        window.removeEventListener('firebaseReady', onFirebaseReady);
                        reject(new Error('Firebase timeout - Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet'));
                    }
                }, 200);
                
                const timeoutId = setTimeout(() => {
                    clearInterval(checkInterval);
                    window.removeEventListener('firebaseReady', onFirebaseReady);
                    reject(new Error('Firebase timeout'));
                }, maxWait);
                
                window.addEventListener('firebaseReady', onFirebaseReady);
            });
        }
        
        // Start background sync
        function startBackgroundSync() {
            // Auto sync m·ªói 30 gi√¢y n·∫øu online
            setInterval(() => {
                if (navigator.onLine) {
                    window.dataManager?.startBackgroundSync();
                }
            }, 30000);
            
            // Sync khi online
            window.addEventListener('online', () => {
                console.log('üåê Online - Starting sync');
                window.dataManager?.startBackgroundSync();
            });
        }
        
        // Update loading detail
        function updateLoadingDetail(message, isError = false) {
            const detail = document.getElementById('loadingDetail');
            if (detail) {
                detail.textContent = message;
                detail.className = isError ? 'error' : '';
            }
        }
        
        // Update sync status UI
        function updateSyncStatusUI(status, pendingCount = 0) {
            const icon = document.getElementById('syncIcon');
            const text = document.getElementById('syncText');
            const badge = document.getElementById('syncBadge');
            
            if (!icon || !text) return;
            
            // Update icon and text
            icon.className = 'fas';
            text.textContent = status;
            
            switch(status) {
                case 'online':
                    icon.classList.add('fa-circle', 'online');
                    break;
                case 'offline':
                    icon.classList.add('fa-circle', 'offline');
                    break;
                case 'syncing':
                    icon.classList.add('fa-sync-alt', 'fa-spin', 'syncing');
                    text.textContent = 'ƒêang ƒë·ªìng b·ªô...';
                    break;
                case 'success':
                    icon.classList.add('fa-check-circle', 'success');
                    text.textContent = 'ƒê√£ ƒë·ªìng b·ªô';
                    // Auto reset sau 2 gi√¢y
                    setTimeout(() => {
                        if (text.textContent === 'ƒê√£ ƒë·ªìng b·ªô') {
                            updateSyncStatusUI(navigator.onLine ? 'online' : 'offline', pendingCount);
                        }
                    }, 2000);
                    break;
                case 'error':
                    icon.classList.add('fa-exclamation-circle', 'error');
                    text.textContent = 'L·ªói ƒë·ªìng b·ªô';
                    // Auto reset sau 3 gi√¢y
                    setTimeout(() => {
                        if (text.textContent === 'L·ªói ƒë·ªìng b·ªô') {
                            updateSyncStatusUI(navigator.onLine ? 'online' : 'offline', pendingCount);
                        }
                    }, 3000);
                    break;
                default:
                    // 'ready' state
                    icon.classList.add('fa-circle', navigator.onLine ? 'online' : 'offline');
                    text.textContent = navigator.onLine ? 'Online' : 'Offline';
            }
            
            // Update badge
            if (pendingCount > 0) {
                badge.textContent = pendingCount;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // H√†m hi·ªÉn th·ªã tab
        function showTab(tabName) {
            // Update active tab UI
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-tab') === tabName) {
                    btn.classList.add('active');
                }
            });
            
            // Render tab content
            const mainContent = document.getElementById('mainContent');
            
            switch(tabName) {
                case 'reports':
                    if (window.reportsModule) {
                        window.reportsModule.render();
                    } else {
                        mainContent.innerHTML = '<div class="error">Module b√°o c√°o ch∆∞a s·∫µn s√†ng</div>';
                    }
                    break;
                case 'inventory':
                    if (window.inventoryModule) {
                        window.inventoryModule.render();
                    } else {
                        mainContent.innerHTML = '<div class="error">Module kho ch∆∞a s·∫µn s√†ng</div>';
                    }
                    break;
                case 'employees':
                    if (window.employeesModule) {
                        window.employeesModule.render();
                    } else {
                        mainContent.innerHTML = '<div class="error">Module nh√¢n vi√™n ch∆∞a s·∫µn s√†ng</div>';
                    }
                    break;
                case 'dashboard':
                    if (window.dashboardModule) {
                        window.dashboardModule.render();
                    } else {
                        mainContent.innerHTML = '<div class="error">Module t·ªïng quan ch∆∞a s·∫µn s√†ng</div>';
                    }
                    break;
                
                default:
                    mainContent.innerHTML = '<div class="error">Tab kh√¥ng t·ªìn t·∫°i</div>';
            }
        }
        
        // H√†m hi·ªÉn th·ªã toast
        function showToast(message, type = 'info', duration = 3000) {
    const container = document.getElementById('toastContainer');
    if (!container) return;
    
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    
    // Ki·ªÉm tra n·∫øu message ch·ª©a HTML
    if (message.includes('<') && message.includes('>')) {
        toast.innerHTML = message;
    } else {
        toast.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            <span>${message}</span>
        `;
    }
    
    container.appendChild(toast);
    
    // Auto remove
    setTimeout(() => {
        toast.classList.add('fade-out');
        setTimeout(() => toast.remove(), 300);
    }, duration);
}
        // H√†m hi·ªÉn th·ªã modal
        function showModal(content, onClose = null) {
            const overlay = document.getElementById('modalOverlay');
            const container = document.getElementById('modalContainer');
            
            container.innerHTML = content;
            
            overlay.classList.add('active');
            container.classList.add('active');
            
            // Close modal khi click overlay
            overlay.onclick = () => closeModal(onClose);
            
            // Close modal v·ªõi Escape key
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    closeModal(onClose);
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
            
            return {
                close: () => closeModal(onClose)
            };
        }
        
        function closeModal(callback = null) {
            const overlay = document.getElementById('modalOverlay');
            const container = document.getElementById('modalContainer');
            
            overlay.classList.remove('active');
            container.classList.remove('active');
            
            if (typeof callback === 'function') {
                callback();
            }
        }
        
        // Tab click handlers
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.getAttribute('data-tab');
                showTab(tab);
            });
        });
        
        // X·ª≠ l√Ω online/offline
        window.addEventListener('online', () => {
            updateSyncStatusUI('online');
            window.showToast?.('ƒê√£ k·∫øt n·ªëi l·∫°i internet', 'success');
        });
        
        window.addEventListener('offline', () => {
            updateSyncStatusUI('offline');
            window.showToast?.('M·∫•t k·∫øt n·ªëi internet - Chuy·ªÉn sang ch·∫ø ƒë·ªô offline', 'warning');
        });
        
        // L·∫Øng nghe sync events t·ª´ dataManager
        window.addEventListener('syncStatusChanged', (event) => {
            const { status, pendingChanges } = event.detail;
            updateSyncStatusUI(status, pendingChanges);
        });
        
        // Expose functions to window
        window.showToast = showToast;
        window.showModal = showModal;
        window.closeModal = closeModal;
        window.showTab = showTab;
        window.updateSyncStatusUI = updateSyncStatusUI;
        
        // Start app khi DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
        
        // Initial sync status
        updateSyncStatusUI(navigator.onLine ? 'online' : 'offline');
    </script>
</body>
</html>